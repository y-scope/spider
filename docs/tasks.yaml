version: "3"

vars:
  # Paths
  G_DOCS_BUILD_DIR: "{{.G_BUILD_DIR}}/docs"
  G_DOCS_WOLF_BUILD_DIR: "{{.G_DOCS_BUILD_DIR}}/wolf"
  G_DOCS_HUNTSMAN_BUILD_DIR: "{{.G_DOCS_BUILD_DIR}}/huntsman"
  G_DOCS_VENV_DIR: "{{.G_BUILD_DIR}}/docs-venv"
  G_NODE_DEPS_DIR: "{{.G_BUILD_DIR}}/docs-node"

  # Target checksum files
  G_DOCS_VENV_CHECKSUM_FILE: "{{.G_BUILD_DIR}}/docs#docs-venv.md5"

tasks:
  clean:
    cmds:
      - "rm -rf '{{.G_DOCS_BUILD_DIR}}'"

  wolf:site:
    cmds:
      - "python3 '{{.ROOT_DIR}}/tools/scripts/find-broken-docs-links.py'"
      - task: "site"
        vars:
          TASK_NAME: "{{.TASK}}"
          CHECKSUM_FILE: "{{.G_BUILD_DIR}}/docs#wolf#site.md5"
          OUTPUT_DIR: "{{.G_DOCS_WOLF_BUILD_DIR}}"
          SRC_DIR: "{{.TASKFILE_DIR}}/wolf"

  wolf:serve:
    deps:
      - "http-server"
      - "wolf:site"
    cmds:
      - "npm --prefix '{{.G_NODE_DEPS_DIR}}' exec http-server '{{.G_DOCS_WOLF_BUILD_DIR}}' -c-1"

  huntsman:site:
    cmds:
      - task: "site"
        vars:
          TASK_NAME: "{{.TASK}}"
          CHECKSUM_FILE: "{{.G_BUILD_DIR}}/docs#huntsman#site.md5"
          OUTPUT_DIR: "{{.G_DOCS_HUNTSMAN_BUILD_DIR}}"
          SRC_DIR: "{{.TASKFILE_DIR}}/huntsman"

  huntsman:serve:
    deps:
      - "http-server"
      - "huntsman:site"
    cmds:
      - "npm --prefix '{{.G_NODE_DEPS_DIR}}' exec http-server '{{.G_DOCS_HUNTSMAN_BUILD_DIR}}' -c-1"

  # Builds a Sphinx documentation site.
  #
  # @param {string} TASK_NAME The name to display for this task.
  # @param {string} CHECKSUM_FILE The path to the checksum file for caching.
  # @param {string} OUTPUT_DIR The directory to output the built site.
  # @param {string} SRC_DIR The source directory containing `conf/` and `src/`.
  site:
    internal: true
    label: "{{.TASK_NAME}}"
    requires:
      vars: ["TASK_NAME", "CHECKSUM_FILE", "OUTPUT_DIR", "SRC_DIR"]
    sources:
      - "{{.G_DOCS_VENV_CHECKSUM_FILE}}"
      - "{{.ROOT_DIR}}/taskfile.yaml"
      - "{{.TASKFILE}}"
      - "conf/**/*"
      - "src/**/*"
    dir: "{{.SRC_DIR}}"
    deps:
      - ":init"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
      - "docs-venv"
    generates: ["{{.CHECKSUM_FILE}}"]
    cmds:
      - "rm -rf '{{.OUTPUT_DIR}}'"
      - |-
        . "{{.G_DOCS_VENV_DIR}}/bin/activate"
        sphinx-build \
          --write-all \
          --fresh-env \
          --conf-dir conf \
          --nitpicky \
          --fail-on-warning \
          --keep-going \
          --builder html \
          src "{{.OUTPUT_DIR}}"
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]

  docs-venv:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_DOCS_VENV_CHECKSUM_FILE}}"
      OUTPUT_DIR: "{{.G_DOCS_VENV_DIR}}"
      REQUIREMENTS_FILE: "docs/requirements.txt"
    deps:
      - ":init"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    cmds:
      - task: ":utils:misc:create-venv"
        vars:
          LABEL: "docs"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          REQUIREMENTS_FILE: "{{.REQUIREMENTS_FILE}}"
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    sources:
      - "{{.REQUIREMENTS_FILE}}"
      - "{{.ROOT_DIR}}/taskfile.yaml"
      - "{{.TASKFILE}}"
    generates: ["{{.CHECKSUM_FILE}}"]

  http-server:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      OUTPUT_DIR: "{{.G_NODE_DEPS_DIR}}"
    deps:
      - ":init"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    cmds:
      - "rm -rf '{{.OUTPUT_DIR}}'"
      - "npm --prefix '{{.OUTPUT_DIR}}' install http-server"
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    sources:
      - "{{.ROOT_DIR}}/taskfile.yaml"
      - "{{.TASKFILE}}"
    generates: ["{{.CHECKSUM_FILE}}"]
