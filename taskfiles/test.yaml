version: "3"

vars:
  G_UNIT_TEST_BINARY: "{{.G_BUILD_SPIDER_DIR}}/tests/unitTest"
  G_TEST_VENV_DIR: "{{.G_BUILD_DIR}}/test-venv"
  G_TEST_VENV_CHECKSUM_FILE: "{{.G_BUILD_DIR}}/test#venv.md5"
  G_MARIADB_DATABASE: "spider-db"
  G_MARIADB_USERNAME: "spider-user"
  G_MARIADB_PASSWORD: "spider-password"

tasks:
  cpp-non-storage-unit-tests:
    deps:
      - "build-unit-test"
    cmds:
      - "{{.G_UNIT_TEST_BINARY}} \"~[storage]\""

  cpp-storage-unit-tests:
    deps:
      - "build-unit-test"
    env:
      SPIDER_STORAGE_URL: "jdbc:mariadb://127.0.0.1:{{.MARIADB_PORT}}/{{.G_MARIADB_DATABASE}}?user={{.G_MARIADB_USERNAME}}&password={{.G_MARIADB_PASSWORD}}"
    vars:
      MARIADB_CONTAINER_NAME:
        # Normalize UUID casing: macOS generates uppercase while Linux generates lowercase.
        sh: "uuidgen | tr '[:upper:]' '[:lower:]' | sed 's/^/spider-mariadb-/'"
      MARIADB_PORT:
        sh: "tools/scripts/storage/get_free_port.py"
    cmds:
      - task: "start-storage"
        vars:
          MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
          MARIADB_DATABASE: "{{.G_MARIADB_DATABASE}}"
          MARIADB_USERNAME: "{{.G_MARIADB_USERNAME}}"
          MARIADB_PASSWORD: "{{.G_MARIADB_PASSWORD}}"
          MARIADB_PORT: "{{.MARIADB_PORT}}"
      - defer: |-
          {{.ROOT_DIR}}/tools/scripts/storage/stop.py \
          --name "{{.MARIADB_CONTAINER_NAME}}"
      - "{{.G_UNIT_TEST_BINARY}} \"[storage]\""

  cpp-unit-tests:
    deps:
      - "build-unit-test"
    env:
      SPIDER_STORAGE_URL: "jdbc:mariadb://127.0.0.1:{{.MARIADB_PORT}}/{{.G_MARIADB_DATABASE}}?user={{.G_MARIADB_USERNAME}}&password={{.G_MARIADB_PASSWORD}}"
    vars:
      MARIADB_CONTAINER_NAME:
        # Normalize UUID casing: macOS generates uppercase while Linux generates lowercase.
        sh: "uuidgen | tr '[:upper:]' '[:lower:]' | sed 's/^/spider-mariadb-/'"
      MARIADB_PORT:
        sh: "tools/scripts/storage/get_free_port.py"
    cmds:
      - task: "start-storage"
        vars:
          MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
          MARIADB_DATABASE: "{{.G_MARIADB_DATABASE}}"
          MARIADB_USERNAME: "{{.G_MARIADB_USERNAME}}"
          MARIADB_PASSWORD: "{{.G_MARIADB_PASSWORD}}"
          MARIADB_PORT: "{{.MARIADB_PORT}}"
      - defer: |-
          {{.ROOT_DIR}}/tools/scripts/storage/stop.py \
          --name "{{.MARIADB_CONTAINER_NAME}}"
      - "{{.G_UNIT_TEST_BINARY}}"

  build-unit-test:
    internal: true
    deps:
      - task: ":build:cpp-target"
        vars:
          TARGETS: ["spider_task_executor", "unitTest", "worker_test"]

  cpp-integration:
    dir: "{{.G_BUILD_SPIDER_DIR}}"
    deps:
      - "venv"
      - task: ":build:cpp-target"
        vars:
          TARGETS: [
            "spider_task_executor",
            "worker_test",
            "client_test",
            "spider_worker",
            "spider_scheduler",
            "integrationTest"]
    env:
      SPIDER_STORAGE_URL: "jdbc:mariadb://127.0.0.1:{{.MARIADB_PORT}}/{{.G_MARIADB_DATABASE}}?user={{.G_MARIADB_USERNAME}}&password={{.G_MARIADB_PASSWORD}}"
    vars:
      MARIADB_CONTAINER_NAME:
        # Normalize UUID casing: macOS generates uppercase while Linux generates lowercase.
        sh: "uuidgen | tr '[:upper:]' '[:lower:]' | sed 's/^/spider-mariadb-/'"
      MARIADB_PORT:
        sh: "tools/scripts/storage/get_free_port.py"
    cmds:
      - task: "start-storage"
        vars:
          MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
          MARIADB_DATABASE: "{{.G_MARIADB_DATABASE}}"
          MARIADB_USERNAME: "{{.G_MARIADB_USERNAME}}"
          MARIADB_PASSWORD: "{{.G_MARIADB_PASSWORD}}"
          MARIADB_PORT: "{{.MARIADB_PORT}}"
      - defer: |-
          {{.ROOT_DIR}}/tools/scripts/storage/stop.py \
          --name "{{.MARIADB_CONTAINER_NAME}}"
      - |-
        . ../test-venv/bin/activate
        ../test-venv/bin/pytest tests/integration

  venv:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_TEST_VENV_CHECKSUM_FILE}}"
      OUTPUT_DIR: "{{.G_TEST_VENV_DIR}}"
    sources:
      - "{{.ROOT_DIR}}/taskfile.yaml"
      - "{{.TASKFILE}}"
      - "requirements-dev.txt"
    generates: ["{{.CHECKSUM_FILE}}"]
    run: "once"
    deps:
      - ":init"
      - task: ":utils:checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]
    cmds:
      - task: ":utils:misc:create-venv"
        vars:
          LABEL: "test"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          REQUIREMENTS_FILE: "{{.ROOT_DIR}}/requirements-dev.txt"
      # This command must be last
      - task: ":utils:checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          INCLUDE_PATTERNS: ["{{.OUTPUT_DIR}}"]

  spider-py-unit-tests:
    dir: "{{.G_SRC_PYTHON_DIR}}"
    env:
      # Don't create __pycache__ directories in the source tree.
      PYTHONDONTWRITEBYTECODE: "1"
      SPIDER_STORAGE_URL: "jdbc:mariadb://127.0.0.1:{{.MARIADB_PORT}}/{{.G_MARIADB_DATABASE}}?user={{.G_MARIADB_USERNAME}}&password={{.G_MARIADB_PASSWORD}}"
    vars:
      MARIADB_CONTAINER_NAME:
        # Normalize UUID casing: macOS generates uppercase while Linux generates lowercase.
        sh: "uuidgen | tr '[:upper:]' '[:lower:]' | sed 's/^/spider-mariadb-/'"
      MARIADB_PORT:
        sh: "tools/scripts/storage/get_free_port.py"
    cmds:
      - task: "start-storage"
        vars:
          MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
          MARIADB_DATABASE: "{{.G_MARIADB_DATABASE}}"
          MARIADB_USERNAME: "{{.G_MARIADB_USERNAME}}"
          MARIADB_PASSWORD: "{{.G_MARIADB_PASSWORD}}"
          MARIADB_PORT: "{{.MARIADB_PORT}}"
      - defer: |-
          {{.ROOT_DIR}}/tools/scripts/storage/stop.py \
          --name "{{.MARIADB_CONTAINER_NAME}}"
      - "uv run pytest"

  spider-py-non-storage-unit-tests:
    dir: "{{.G_SRC_PYTHON_DIR}}"
    env:
      # Don't create __pycache__ directories in the source tree.
      PYTHONDONTWRITEBYTECODE: "1"
    cmds:
      - "uv run pytest -m \"not storage\""

  spider-py-storage-unit-tests:
    dir: "{{.G_SRC_PYTHON_DIR}}"
    env:
      # Don't create __pycache__ directories in the source tree.
      PYTHONDONTWRITEBYTECODE: "1"
      SPIDER_STORAGE_URL: "jdbc:mariadb://127.0.0.1:{{.MARIADB_PORT}}/{{.G_MARIADB_DATABASE}}?user={{.G_MARIADB_USERNAME}}&password={{.G_MARIADB_PASSWORD}}"
    vars:
      MARIADB_CONTAINER_NAME:
        # Normalize UUID casing: macOS generates uppercase while Linux generates lowercase.
        sh: "uuidgen | tr '[:upper:]' '[:lower:]' | sed 's/^/spider-mariadb-/'"
      MARIADB_PORT:
        sh: "tools/scripts/storage/get_free_port.py"
    cmds:
      - task: "start-storage"
        vars:
          MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
          MARIADB_DATABASE: "{{.G_MARIADB_DATABASE}}"
          MARIADB_USERNAME: "{{.G_MARIADB_USERNAME}}"
          MARIADB_PASSWORD: "{{.G_MARIADB_PASSWORD}}"
          MARIADB_PORT: "{{.MARIADB_PORT}}"
      - defer: |-
          {{.ROOT_DIR}}/tools/scripts/storage/stop.py \
          --name "{{.MARIADB_CONTAINER_NAME}}"
      - "uv run pytest -m \"storage\""

  start-storage:
    vars:
      MARIADB_CONTAINER_NAME: "{{.MARIADB_CONTAINER_NAME}}"
      MARIADB_DATABASE: "{{.MARIADB_DATABASE}}"
      MARIADB_USERNAME: "{{.MARIADB_USERNAME}}"
      MARIADB_PASSWORD: "{{.MARIADB_PASSWORD}}"
      MARIADB_PORT: "{{.MARIADB_PORT | default 3306}}"
    cmds:
      - |-
        tools/scripts/storage/start.py \
        --name "{{.MARIADB_CONTAINER_NAME}}" \
        --port "{{.MARIADB_PORT}}" \
        --database "{{.MARIADB_DATABASE}}" \
        --username "{{.MARIADB_USERNAME}}" \
        --password "{{.MARIADB_PASSWORD}}"
      - |-
        tools/scripts/storage/wait_for_db.py \
        --name "{{.MARIADB_CONTAINER_NAME}}"
      - |-
        tools/scripts/storage/init_db.py \
        --port "{{.MARIADB_PORT}}" \
        --database "{{.MARIADB_DATABASE}}" \
        --username "{{.MARIADB_USERNAME}}" \
        --password "{{.MARIADB_PASSWORD}}"
