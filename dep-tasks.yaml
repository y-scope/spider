version: "3"

vars:
  G_SCRIPT_DIR: "{{.ROOT_DIR}}/tools/scripts"

tasks:

  lib_install:
    deps: ["lib_install_mac", "lib_install_linux"]

  lib_install_mac:
    internal: true
    platforms: ["darwin"]
    dir: "{{.G_SCRIPT_DIR}}/lib_install/macOS"
    cmds:
      - "./install-lib.sh"
      - task: "dep_install"

  lib_install_linux:
    internal: true
    platforms: ["linux"]
    dir: "{{.G_SCRIPT_DIR}}/lib_install/linux"
    cmds:
      - "./install-lib.sh"
      - task: "dep_install"

  dep_install:
    cmds:
      - task: ":utils:cmake:install-deps-and-generate-settings"
        vars:
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          DEP_TASK: "deps:install-all-run"

  install-all-run:
    internal: true
    deps:
      - task: "install-abseil"
      - task: "install-Catch2"
      - task: "install-outcome"
      - task: "download-ystdlib"
      - task: "install-spdlog"
      - task: "install-mariadb-connector-cpp"
      - task: "install-msgpack"

  install-abseil:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "absl"
          WORK_DIR: "{{.G_DEPS_DIR}}/absl"
          FILE_SHA256: "b396401fd29e2e679cace77867481d388c807671dc2acc602a0259eeb79b7811"
          URL: "https://github.com/abseil/abseil-cpp/archive/refs/tags/20250127.1.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  install-Catch2:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "Catch2"
          WORK_DIR: "{{.G_DEPS_DIR}}/Catch2"
          FILE_SHA256: "1ab2de20460d4641553addfdfe6acd4109d871d5531f8f519a52ea4926303087"
          URL: "https://github.com/catchorg/Catch2/archive/refs/tags/v3.8.0.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  install-outcome:
    internal: true
    run: "once"
    deps:
      - "install-quickcpplib"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "outcome"
          WORK_DIR: "{{.G_DEPS_DIR}}/outcome"
          FILE_SHA256: "0382248cbb00806ce4b5f3ce6939797dc3b597c85fd3531614959e31ef488b39"
          URL: "https://github.com/ned14/outcome/archive/refs/tags/v2.2.11.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-C {{.G_DEPS_CMAKE_SETTINGS_DIR}}/quickcpplib.cmake"
            - "-DBUILD_TESTING=OFF"
            - "-DCMAKE_BUILD_TYPE=Release"
            - "-DCMAKE_POLICY_DEFAULT_CMP0074=NEW"
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  install-quickcpplib:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "quickcpplib"
          WORK_DIR: "{{.G_DEPS_DIR}}/quickcpplib"
          FILE_SHA256: "5d4c9b2d6fa177d3fb14f3fe3086867e43b44f4a7a944eb10ee4616b2b0f3c05"
          URL: "https://github.com/ned14/quickcpplib/archive/f3e452e.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DBUILD_TESTING=OFF"
            - "-DCMAKE_BUILD_TYPE=Release"
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  download-ystdlib:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:remote:download-and-extract-tar"
        vars:
          FILE_SHA256: "d3fc9804eacb3ee4f156ae0ca37151cb04847580"
          OUTPUT_DIR: "{{.G_DEPS_DIR}}/ystdlib/ystdlib-src"
          URL: "https://github.com/y-scope/ystdlib-cpp/archive/d3fc980.tar.gz"
      - |
        cat <<EOF >> "{{.G_DEPS_CMAKE_SETTINGS_DIR}}/ystdlib.cmake"
        set(
        SPIDER_YSTDLIB_SOURCE_DIRECTORY "{{.G_DEPS_DIR}}/ystdlib/ystdlib-src"
        )
        EOF

  install-fmtlib:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "fmt"
          WORK_DIR: "{{.G_DEPS_DIR}}/fmtlib"
          FILE_SHA256: "6cb1e6d37bdcb756dbbe59be438790db409cdb4868c66e888d5df9f13f7c027f"
          URL: "https://github.com/fmtlib/fmt/archive/refs/tags/11.0.2.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  install-spdlog:
    internal: true
    run: "once"
    deps:
      - "install-fmtlib"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "spdlog"
          WORK_DIR: "{{.G_DEPS_DIR}}/spdlog"
          FILE_SHA256: "9962648c9b4f1a7bbc76fd8d9172555bad1871fdb14ff4f842ef87949682caa5"
          URL: "https://github.com/gabime/spdlog/archive/refs/tags/v1.15.0.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
            - "-DUSE_EXTERNAL_FMT=ON"
            - "-C {{.G_DEPS_CMAKE_SETTINGS_DIR}}/fmt.cmake"

  install-mariadb-connector-cpp:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "mariadb-connector-cpp"
          WORK_DIR: "{{.G_DEPS_DIR}}/mariadb-connector-cpp"
          FILE_SHA256: "0e3dfe9f2bc3f7bb6f7c159009556290064a7c23402ea08019fa8aebfc3ff2c9"
          URL: "https://github.com/mariadb-corporation/mariadb-connector-cpp/archive/refs/tags/\
            1.1.5.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
            - "-DUSE_SYSTEM_INSTALLED_LIB=ON"
            - "-DINSTALL_LAYOUT=RPM"

  install-msgpack:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:cmake:install-remote-tar"
        vars:
          NAME: "msgpack-cxx"
          WORK_DIR: "{{.G_DEPS_DIR}}/msgpack"
          FILE_SHA256: "7504b7af7e7b9002ce529d4f941e1b7fb1fb435768780ce7da4abaac79bb156f"
          URL: "https://github.com/msgpack/msgpack-c/releases/download/\
            cpp-7.0.0/msgpack-cxx-7.0.0.tar.gz"
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CMAKE_SETTINGS_DIR}}"
          GEN_ARGS:
            - "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"

  install-boost:
    internal: true
    run: "once"
    cmds:
      - task: ":utils:remote:download-and-extract-tar"
        vars:
          FILE_SHA256: "f65731647dae9e739882ae5ea300ff066bc8beb7b8458790f4a94525cec82b11"
          OUTPUT_DIR: "{{.G_DEPS_DIR}}/boost/boost-src"
          URL: "https://github.com/boostorg/boost/archive/refs/tags/boost-1.86.0.tar.gz"
      -